---
title: "test"
author: "Elliott O'Brien"
date: "February 19, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lattice)
library(broom)
library(purrr)
library(knitr)
```

## R Markdown

```{r load_data}
load("Baseball.RData")
```

## Including linear models

You can also embed plots, for example:

```{r filter}
active_batters_2016 <- Batting %>% 
  filter(yearID == 2016, AB > 0) %>% # at least one at bat during 2016 year
  select(playerID) %>% 
  left_join(Batting, by='playerID')
```

```{r linear_model}
estimated_hits <- active_batters_2016 %>%
  group_by(playerID) %>% 
  do(
    coefs = lm(H ~ yearID, data = .) %>% tidy %>% select(estimate) %>% unlist #replace with a function
  ) %>% 
  left_join( # joins estimates to 2017 data for QC
    Batting2017 %>% 
      filter(AB > 0) %>%  # only show QC for 2017 players that had at least one at bat and no missing data
      select(Handle, H),
    by=c("playerID" = "Handle")
  ) %>%  
  mutate(
    estimate = ifelse(length(coefs) == 2, round(coefs[1] + coefs[2]*2017), round(coefs[1])),
    bias = estimate - H
  )
```

```{r linear_mixed_model}
library(nlme)

hits.lme <- active_batters_2016 %>%
  group_by(playerID) %>%
  lme(H ~ yearID, random=~1|playerID, data = .) %>% predict(
    newdata = Batting2017 %>% 
      filter(AB > 0, Tm != 'TOT') %>%  # only show QC for 2017 players that had at least one at bat and no missing data
      select(Handle, H) %>%
      group_by(Handle) %>%
      summarize(H = sum(H, na.rm=T)) %>%
      filter(Handle != '') %>%
      rename(playerID = Handle) %>%
      mutate(yearID = 2017)
  ) %>% 
  tidy %>%
  rename(playerID = names, estimate=x) %>%
  left_join(
    Batting2017 %>% 
      filter(AB > 0, Tm != 'TOT') %>%  # only show QC for 2017 players that had at least one at bat and no missing data
      select(Handle, H) %>%
      group_by(Handle) %>%
      summarize(H = sum(H, na.rm=T)) %>%
      filter(Handle != '') %>%
      rename(playerID = Handle)
  ) %>%
  mutate(
     bias = estimate - H
  )

kable(hits.lme)
```

The linear mixed model is under estimating on average with a average bias of `r mean(hits.lme$bias, na.rm=T)`.
